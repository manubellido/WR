var KEY_ENTER=13,KEY_TAB=9;window.fbAsyncInit=function(){FB.init({appId:FACEBOOK_APP_ID,status:true,cookie:true})};$(document).ready(function(){$("#welcomeCarousel").carousel({interval:5E3});columnize();bindActions();calcDistances();bindWidgets();bindShare();bindCitySearch();bindLoadMore();bindRemix();bindAccountSettings();$("#load-more").css("display","block").show()});function storageSet(a,b){if(window.localStorage){localStorage.setItem(a,b);return b}}
function storageGet(a){if(window.localStorage)return localStorage.getItem(a)}
function ColSet(a,b){this.PADDING=36;this.$section=$(a).css("position","relative");this.getLimits();var c=this,e,f,d,h=navigator.appName=="Microsoft Internet Explorer",g=function(){if(h){window.onresize=null;c.update(b);setTimeout(function(){window.onresize=g},10);return false}clearTimeout(e);clearTimeout(f);clearTimeout(d);e=setTimeout(function(){c.update(b);f=setTimeout(function(){c.update(b);d=setTimeout(function(){c.update(b)},300)},300)},100)};g();window.onresize=g}
ColSet.prototype.getLimits=function(){var a=this.$section.attr("data-columns").split(/\s*,\s*/),b=parseInt(a[0],10);a=parseInt(a[1],10);if(isNaN(a)||a<b)a=b;if(isNaN(b))console.error([b,a]);else{this.min=b;this.max=a}};ColSet.prototype.getColWidth=function(){var a=this.$section.width(),b=Math.ceil(a/this.max),c=Math.floor(a/b);if(c<this.min){b-=1;c=Math.floor(a/b)}this.colWidth=c;this.numCols=b};ColSet.prototype.update=function(a){a?this.sorted_update():this.masonry_update()};
ColSet.prototype.sorted_update=function(){var a=this.$section.children();a=_.toArray(a);var b=a.length;this.getColWidth();var c=this.colWidth,e=this.numCols,f=0,d=[],h,g,i,j,k;for(h=0;h<b;h+=e){for(g=f=0;g<e;g+=1){i=a[h+g];if(!i)break;i=$(i);j=i.find("[data-ratio-hw]");k=parseInt(j.attr("data-ratio-hw"),10)/100;j.css({width:c-this.PADDING+"px",height:k*(c-this.PADDING)+"px"});i.css({top:(d[g]||0)+"px",left:f+"px",width:c+"px",visibility:"visible",display:"block"});f+=c;d[g]=(d[g]||0)+i.height()}this.$section.height(_.max(d))}this.y=
d;this.$section.height(_.max(d))};
ColSet.prototype.masonry_update=function(){var a=this.$section,b=a.children();b=_.toArray(b);this.getColWidth();var c=this.colWidth,e=this.numCols,f=this.PADDING,d,g,h,i,j=[];for(d=0;d<e;d++)j[d]=0;_.each(b,function(k){g=$(k);d=_.indexOf(j,_.min(j));h=g.find("[data-ratio-hw]");i=parseInt(h.attr("data-ratio-hw"),10)/100;h.css({width:c-f+"px",height:i*(c-f)+"px"});g.css({top:(j[d]||0)+"px",left:d*c+"px",width:c+"px",visibility:"visible",display:"block"});j[d]=(j[d]||0)+g.height();a.height(_.max(j))});
this.y=j};ColSet.prototype.append=function(a){var b=this.y,c=this.colWidth,e=_.indexOf(b,_.min(b));a=$(a);var f=a.find("[data-ratio-hw]"),d=parseInt(f.attr("data-ratio-hw"),10)/100;f.css("height",d*(c-this.PADDING)+"px");a.css({top:(b[e]||0)+"px",left:e*c+"px",width:c+"px",visibility:"visible",display:"block"});this.$section.append(a);b[e]=(b[e]||0)+a.height();this.$section.height(_.max(b));this.y=b};function columnize(){$("[data-columns]").each(function(a,b){$(b).data("colset",new ColSet(b))})}
function bindWidgets(){$("[placeholder]").placeholder();$(".no-touch .btn-tooltip").tooltip();$(".dropdown-toggle").dropdown();$(".styled-checks input").on("change",function(){$(this).parents("label").toggleClass("checked",$(this).is(":checked"))})}
function bindShare(){$(document).on("click",".social-sharing .btn",function(a){a.preventDefault();var b=$(this);a=b.parents(".social-sharing");b=b.attr("data-type");var c=a.attr("data-url")||window.location.href;a=a.attr("data-message")||"";share(b,c,a)});$(document).on("click","[data-embed]",function(a){a.preventDefault();a=$(this).attr("data-url")||window.location.href+"embedform/";window.open(a,"embedform","width=600, height=400")})}
function share(a,b,c){({facebook:facebookShare,twitter:twitterShare})[a](b,c)}
function facebookShare(a){a=["app_id="+FACEBOOK_APP_ID,"link="+a,"redirect_uri="+a,"display=popup"];var b=$('meta[property="og:image"]').attr("content");b&&a.push("picture="+b);if(b=$('meta[property="og:title"]').attr("content")){b=encodeURIComponent(b);a.push("name="+b)}if(b=$('meta[property="og:caption"]').attr("content")){b=encodeURIComponent(b);a.push("caption="+b)}if(b=$('meta[property="og:description"]').attr("content")){b=encodeURIComponent(b);a.push("description="+b)}a="https://www.facebook.com/dialog/feed?"+
a.join("&");window.open(a,"facebook_share","width=600, height=300")}function twitterShare(a,b){var c=140-a.length-9-3;if(b.length>c){b=b.substr(0,c-2);b+="\u2026"}b=[b,a,"#worldrat"].join(" ");c="http://twitter.com/intent/tweet?text="+encodeURIComponent(b);window.open(c,"twitter_share","width=600, height=400")}
function bindCitySearch(){var a=$(".city-search");if(a.length!==0){var b=function(){$.trim(a.val())||a.val(a.attr("data-default")||"")},c=new google.maps.places.Autocomplete(a[0],{types:["(cities)"]});google.maps.event.addListener(c,"place_changed",function(){a.blur();var e=c.getPlace();if(!e||!e.address_components){b();return false}var f=a.attr("data-url");if(!f){b();return false}e={address_components:e.address_components,section:a.attr("data-category")||"home"};$("[data-columns]").addClass("wait");
$.ajax({type:"POST",url:f,data:JSON.stringify(e),success:function(d){if(d&&d.link)window.location.href=d.link.href},error:function(d,h,g){$("[data-columns]").removeClass("wait");console.error(g)},dataType:"json"})});a.on("mousedown",function(e){e.preventDefault();e.stopPropagation();a[0].select();b();return false});a.on("blur",function(){b()});a.on("keydown",function(e){var f=$.trim(a.val());if(e.which==KEY_ENTER&&f.search(/world/)!==-1){e.preventDefault();e.stopPropagation();e=a.attr("data-category");
window.location.href=e?"/routes/categories/"+e:"/";return false}});$(document).on("mousedown",function(){b()})}}
function bindLoadMore(){$("#load-more").on("click",function(){var a=$(this).addClass("wait").prop("disabled",true),b=a.attr("data-target-href"),c=a.attr("data-page"),e=a.attr("data-page-type"),f=a.attr("data-category");$.ajax({type:"POST",url:b,data:{page:c,page_type:e,category_type:f}}).done(function(d){a.removeClass("wait");if(!d||d.hide_button){a.addClass("nomore").text(a.attr("data-nomore"));if(!d)return}else a.prop("disabled",false);var h=d.raw_html;if(h){var g=$("[data-columns]").eq(0).data("colset");
h=h.replace(/\n+/gi,"").replace(/\s+/gi," ");$(h).filter(".flow-item").each(function(){g.append(this)})}a.attr("data-page",d.page)})})}function makeScrollTo(a){return function(){var b=$("#r-"+a),c=b.offset();c&&$("html, body").animate({scrollTop:c.top},function(){highlight(b.find("div").eq(0))}).focus()}}
function insertRealMap(a,b){var c=new GMaps({div:a,zoom:13,scrollwheel:false}),e=c.map,f,d=new google.maps.LatLngBounds,h=[];_.each(b,function(g){c.addMarker({lat:g.lat,lng:g.lng,title:g.title,click:makeScrollTo(g.id)});f=new google.maps.LatLng(g.lat,g.lng);d.extend(f);h.push([g.lat,g.lng])});e.setCenter(d.getCenter());e.fitBounds(d);c.drawPolyline({path:h,strokeColor:"#1b60e8",strokeOpacity:0.4,strokeWeight:6});$("#expand-map").click(function(g){g.preventDefault();g.stopPropagation();g=$(this);var i=
g.hasClass("expanded")?300:500;g.toggleClass("expanded");c.map.setOptions({disableDefaultUI:true});$("#map").animate({height:i+"px"},300,function(){google.maps.event.trigger(c.map,"resize");c.map.setOptions({disableDefaultUI:false})});return false});return c}function insertStaticMap(a,b){$("#expand-map").hide();if(b.length!==0){var c=$(a),e=GMaps.staticMapURL({size:[c.width(),c.height()],lat:b[0].lat,lng:b[0].lng,markers:b});$("<img/>").attr("src",e).appendTo(c);return c[0]}}
function easeInOut(a,b,c,e,f){b=b-a;return Math.ceil(a+Math.pow(1/c*e,f)*b)}function doBGFade(a,b,c,e,f,d,h){a.bgFadeInt&&window.clearInterval(a.bgFadeInt);var g=0;a.bgFadeInt=window.setInterval(function(){a.css("backgroundColor","rgb("+easeInOut(b[0],c[0],f,g,h)+","+easeInOut(b[1],c[1],f,g,h)+","+easeInOut(b[2],c[2],f,g,h)+")");g++;if(g>f){a.css("backgroundColor",e);window.clearInterval(a.bgFadeInt)}},d)}function highlight(a){var b=[255,255,255];doBGFade(a,[241,221,104],b,b,40,20,4)}
function bindRemix(){var a=$("#circuit-remix");if(a.length){a.modal({show:false});$("section").on("click","[data-remix]",function(b){b.preventDefault();b.stopPropagation();b=$(this);a.find("input[name=name]").val(b.attr("data-name"));a.find("select[name=category]").val(b.attr("data-cat"));a.find("#remix-route-name").html(b.attr("data-name"));a.attr("action",b.attr("data-remix"));a.modal("show")})}}function bindActions(){bindToggleButtons();bindRadioButtons()}
function bindToggleButtons(){$("section").on("click","[data-toggle-class]",function(a){a.preventDefault();a.stopPropagation();a=$(this);var b=a.attr("data-toggle-class"),c=a.hasClass(b),e=a.attr("data-msg");if(e&&!confirm(e))return false;var f=c?"off":"on";c=a.attr("data-title-"+f);e=a.attr("data-text-"+f);f=a.attr("data-url-"+f);a.toggleClass(b);if(c)a.attr("data-original-title")?a.attr("data-original-title",c):a.attr("title",c);e&&a.find("span").text(e);if(!f)return false;$.ajax({type:"POST",url:f,
success:function(d){if(d&&d.link)window.location.href=d.link.href},error:function(d,h,g){console.error(g)},dataType:"json"});return false})}
function bindRadioButtons(){$("section").on("click","[data-val]",function(a){a.preventDefault();a.stopPropagation();var b=$(this),c=b.parents("[data-radio]");a=c.attr("data-radio");var e=c.attr("data-name"),f=b.attr("data-val");b=b.attr("data-val-class");if(c.attr("data-val")==f){f=0;b=""}c.attr("data-val",f);c[0].className=b;if(!a)return false;c={};c[e]=f;$.ajax({type:"POST",url:a,data:c,success:function(d){if(d&&d.link)window.location.href=d.link.href},error:function(d,h,g){console.error(g)},dataType:"json"});
return false})}function calcDistances(){var a=$("[data-coords]");if(!(a.length===0||typeof GMaps==="undefined")){var b=function(){a.hide()};GMaps.geolocate({success:function(c){var e=[c.coords.latitude,c.coords.longitude];a.each(function(){var f=$(this),d=f.attr("data-coords").split(/\s*,\s*/),h=parseFloat(d[0],10);d=parseFloat(d[1],10);if(!(isNaN(h)||isNaN(d))){h=getDistance(e,[h,d]);f.find("span").text(h)}})},error:b,not_supported:b,options:{maximumAge:3E5}})}}
function toggle_more_cats_sidebar(){var a=$("#more-cats-controller a");a.click(function(){a.toggleClass("show");$("#more-cats").collapse("toggle")})}
function humanDate(a){var b=new Date;a=new Date(a);var c=b.getYear()-a.getYear();if(c>0){if(c===1)return c+" year ago.";return c+" years ago."}c=b.getMonth()-a.getMonth();if(c>0){if(c===1)return c+" month ago.";return c+" months ago."}c=b.getDay()-a.getDay();if(c>0){if(c===1)return c+"day ago.";return c+" days ago."}b=b.getMinutes()-a.getMinutes();if(b>0){if(b===1)return b+" minute ago.";return b+" minutes ago."}return"Just now"}var PI_180=Math.PI/180;
function getDistance(a,b){var c=a[0],e=b[0],f=(e-c)*PI_180,d=(b[1]-a[1])*PI_180;c=Math.sin(f/2)*Math.sin(f/2)+Math.cos(c*PI_180)*Math.cos(e*PI_180)*Math.sin(d/2)*Math.sin(d/2);c=6371*2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c));if(c<1)return Math.round(c*1E3)+" m";return Math.round(c*10)/10+" Km"}function setLastEmailIndex(){var a=$(".user-email").last().attr("data-index");$("ul.emails").attr("data-index",a)}
function bindAccountSettings(){setLastEmailIndex();$("#append-email").on("click",function(){var a=$(this).attr("data-target-href"),b=$("#email-candidate").val();$.ajax({type:"POST",url:a,data:{email:b}}).done(function(c){if(c.status=="OK"){var e=(parseInt($(".user-email").last().attr("data-index"))+1).toString();$("ul.emails").append('<li data-index="'+e+'"><span class="user-email not-verified"</span><span class="delete-email" data-index="'+e+'">X</span></li>');$("#notifications").html('<p class="alert alert-success">Se te ha enviado un correo para verificar la direcci\u00f3n</p>')}c.status==
"error"&&$("#notifications").html('<p class="alert alert-error">'+c.message+"</p>");setLastEmailIndex()})});$(".delete-email").on("click",function(){var a=$(this),b=a.attr("data-target-href");a=a.attr("data-index");a=$('.user-email[data-index="'+a+'"]').text();$.ajax({type:"POST",url:b,data:{email:a}}).done(function(c){if(c.status=="OK"){$(".user-email").last().parent().remove();$("#notifications").html('<p class="alert alert-success">Se ha desasociado la cuenta de correo.</p>')}c.status=="error"&&
$("#notifications").html('<p class="alert alert-error">'+c.message+"</p>");setLastEmailIndex()})})}
$(document).ajaxSend(function(a,b,c){function e(d){var h=null;if(document.cookie&&document.cookie!=="")for(var g=document.cookie.split(";"),i=0;i<g.length;i++){var j=jQuery.trim(g[i]);if(j.substring(0,d.length+1)==d+"="){h=decodeURIComponent(j.substring(d.length+1));break}}return h}function f(d){var h="//"+document.location.host,g=document.location.protocol+h;return d==g||d.slice(0,g.length+1)==g+"/"||d==h||d.slice(0,h.length+1)==h+"/"||!/^(\/\/|http:|https:).*/.test(d)}!/^(GET|HEAD|OPTIONS|TRACE)$/.test(c.type)&&
f(c.url)&&b.setRequestHeader("X-CSRFToken",e("csrftoken"))});jQuery.fn.shakeIt=function(a){a=jQuery.extend({speed:40,duration:400,spread:20},a);return this.each(function(){var b=jQuery(this),c=(a.spread-1)/2,e=function(){b.css("left",Math.floor(Math.random()*a.spread)-c+"px")};(function(){b.css("position","relative");var f=setInterval(e,a.speed);setTimeout(function(){clearInterval(f);b.css({position:"static"})},a.duration)})()})};
