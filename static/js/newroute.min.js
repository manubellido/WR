var KEY_DELETE=8,KEY_ENTER=13,W={};$(document).ready(function(){$("#error").alert();W.geo.init();W.route.init();W.search.init()});
W.globals={SEARCH_RADIUS:5E4,SEARCH_LIMIT:40,SEARCH_LOCALE:"en",FOURSQUARE_CLIENT_ID:"WW2TD5MTTF1B10WM0CPZJTCUYDONXPSWPPQZ0QEHXNSDA5VS",FOURSQUARE_CLIENT_SECRET:"IYOLFXAEUDWJASJPWVUUPDXNI1EBZAWODZPBKE3IBTG1MCLA",DEFAULT_CAT_ID:"4e67e38e036454776db1fb3a",SEARCH_KEYDOWN_MINLEN:1,SEARCH_KEYDOWN_WAIT:400,SEARCH_RESULTS_MAP_SIZE:[260,260],SEARCH_RESULTS_ZOOM_LEVEL:17,LAT:-12.1259255,LNG:-77.0289959,LATLNG_CITY_KEY:"latlng_city",LATLNG_COORDS_KEY:"latlng_coords",_:""};
W.error=function(a){$("#error div.error-body").html(a);$("#error").slideDown()};W.storageSet=function(a,b){if(window.localStorage){localStorage.setItem(a,b);return b}};W.storageGet=function(a){if(window.localStorage)return localStorage.getItem(a)};W.geo={};W.geo.init=function(){this.$cityInput=$("#city");this.restoreLocation();this.bindCitySearch()};
W.geo.setLocation=function(a,b){var c=W.geo.$cityInput,d=[a,b].join(",");W.globals.LAT=a;W.globals.LNG=b;c.attr("data-coords",d);W.storageSet(W.globals.LATLNG_COORDS_KEY,d);W.storageSet(W.globals.LATLNG_CITY_KEY,c.val())};
W.geo.restoreLocation=function(){var a=$("#city"),b=W.storageGet(W.globals.LATLNG_COORDS_KEY),c=W.storageGet(W.globals.LATLNG_CITY_KEY);if(b){a.val(c);b=b.split(",");W.geo.setLocation(b[0],b[1])}else{b=a.attr("data-coords").split(",");var d=+b[0],f=+b[1];GMaps.geolocate({success:function(e){W.geo.setLocation(e.coords.latitude,e.coords.longitude)},error:function(e){console.error(e.message);W.geo.setLocation(d,f)},not_supported:function(){W.geo.setLocation(d,f)}})}};
W.geo.bindCitySearch=function(){var a=W.geo.$cityInput;if(a.length!==0){var b=function(){$.trim(a.val())||a.val(a.attr("data-default")||"")};a.on("mousedown",function(d){d.preventDefault();d.stopPropagation();a[0].select();return false});a.on("keydown",function(d){if(d.which==KEY_ENTER){d.preventDefault();d.stopPropagation();W.search.$searchInput.trigger("keypress");return false}});$(document).on("mousedown",function(){b()});var c=new google.maps.places.Autocomplete(a[0],{types:["(cities)"]});google.maps.event.addListener(c,
"place_changed",function(){var d=c.getPlace();if(!d){b();return false}d=d.geometry.location;W.geo.setLocation(d.lat(),d.lng());W.search.$searchInput.trigger("keypress")})}};W.route={};W.route.init=function(){var a=$("<div/>").html(CIRCUIT_DATA).text();this.data=$.parseJSON(a);this.stops={};this.tmpl_new_stop=$("#tmpl-new-stop").html();this.bindModals();this.initStops()};
W.route.bindModals=function(){var a=$("#route-edit-modal");a.modal({show:false});W.route.$modal=a;a.find(".btn-primary").on("click",function(d){d.preventDefault();d.stopPropagation();W.route.save()&&a.modal("hide");return false});var b=$("._delete-route-form");b.on("submit",function(d){if(!confirm(b.attr("data-msg"))){d.preventDefault();return false}});$("._route-edit-trigger").click(function(){W.route.edit()});var c=$("#route-picture-edit-modal");W.route.$modalPicture=c;W.route.picIframe=$('iframe[name="'+
c.attr("target")+'"]')[0];$("._route-pic-trigger").on("click",function(){W.route.editPicture()})};W.route.edit=function(){var a=W.route.$modal,b=W.route.data;a.find("[name=name]").val(b.name);a.find("[name=category]").val(b.category);a.find("[name=description]").val(b.description);a.modal("show")};
W.route.save=function(){var a=W.route.$modal,b=W.route.data,c={},d=a.find("[name=name]");if(!$.trim(d.val())){d.focus().shakeIt();return false}c.circuit_id=b.id;c.name=d.val();c.category=a.find("[name=category]").val();c.description=a.find("[name=description]").val();a=a.find("[name=category]");b.name=c.name;b.category=a.val();b.category_display=a.find("option:selected").text();b.description=c.description;W.route.data=b;$(".route-title").text(b.name);$(".category-display").text(b.category_display);
$(".route-description").text(b.description);$.ajax({type:"POST",url:CIRCUIT_EDIT_URL,data:c,error:function(f,e,i){console.error(i)}});$("#route-stops").data("colset").update(true);return true};
W.route.editPicture=function(){var a=W.route.$modalPicture,b=W.route.data,c=$(".route-main-pic"),d=W.route.picIframe;a.find("img").attr("src",b.picture_url);a.modal("show");d.contentWindow.document.innerHTML="";d.removeAttribute("src");a.unbind("submit").submit(function(){c.addClass("wait");a.modal("hide")});d.onload=function(){c.removeClass("wait");var f=$(d.contentWindow.document.body),e;try{e=$.parseJSON(f.text())}catch(i){e=null}if(!e||e.error){e=e?e.error:f.html();W.error(e)}else{W.route.data.picture_url=
e.picture_url;f=c.find("img");if(f.length===0)f=$("<img />").prependTo(c);f.attr("src",e.picture_url).attr("data-ratio-hw",e.picture_ratio_hw);e=$("#route-stops");e.find("._route-pic-trigger").hide();e.data("colset").update(true)}}};
W.route.initStops=function(){var a=$("#route-stops"),b={};a.find("._stop").each(function(){var d=new W.Stop(this);b[d.data.place_id]=d});W.route.stops=b;a.on("click",".stop-edit",function(){var d=this.getAttribute("data-id"),f=W.route.stops[d];f?f.edit():console.error("Missing place_id="+d)});var c=$("#stop-edit-modal");c.modal({show:false});W.Stop.prototype.$modal=c;W.Stop.prototype.iframe=$('iframe[name="'+c.attr("target")+'"]')[0];c.find("button.stop-remove").on("click",function(d){d.preventDefault();
d.stopPropagation();if((d=$(this).attr("data-msg"))&&!confirm(d))return false;c.data("stop").remove();c.modal("hide");return false})};
W.route.addStop=function(a){var b=$(W.route.tmpl_new_stop),c=a.picture_url;c?b.find("img").attr("src",c):b.find("img").remove();b.find(".stop-type").text(a.place_type);b.find(".stop-name").text(a.name);b.find(".stop-address").text(a.address);b.find(".stop-description").text(a.description);b.find(".stop-edit").attr("data-id",a.place_id);c=$("#route-stops");b.insertAfter(c.find("._sticky:last"));c.data("colset").update(true);b.find(".item-options .btn").tooltip();b=new W.Stop(b,a);W.route.stops[a.place_id]=
b};W.route.removeStop=function(a){delete W.route.stops[a.data.place_id];$("#route-stops").data("colset").u(true)};W.Stop=function(a,b){this.$stop=$(a);if(!b){var c=$("<div/>").html(this.$stop.attr("data-json")).text();b=$.parseJSON(c);this.$stop.removeAttr("data-json")}this.data=b};
W.Stop.prototype.edit=function(){var a=this,b=a.$modal,c=a.data;b.data("stop",a);b.attr("action",c.update_url);b.find(".stop-delete").attr("href",c.delete_url);b.find(".stop-name").text(c.name);b.find(".cat").text(c.place_type);b.find(".stop-address").text(c.address);b.find("img").attr("src",c.picture_url);b.find("[name=description]").val(c.description);b.find("[name=stop_id]").val(c.place_id);b.modal("show");a.iframe.contentWindow.document.innerHTML="";a.iframe.removeAttribute("src");b.unbind("submit").submit(function(){a.$stop.addClass("wait");
b.modal("hide")});a.iframe.onload=function(){a.$stop.removeClass("wait");var d=$(a.iframe.contentWindow.document.body),f;try{f=$.parseJSON(d.text())}catch(e){f=null}if(!f||f.error){d=f?f.error:d.html();W.error(d)}else a.update(f)}};W.Stop.prototype.remove=function(){var a=this;$.ajax({type:"POST",url:a.data.delete_url,success:function(){var b=a.$stop;b.animate({opacity:0},function(){b.remove();$("#route-stops").data("colset").update(true)});W.route.removeStop(a)},error:function(b,c,d){console.error(d)}})};
W.Stop.prototype.update=function(a){var b=this.$stop;b.find(".stop-name").text(a.name);b.find(".stop-address").text(a.address);b.find(".stop-description").text(a.description);b.find("._stop-thumbnail").attr("src",a.picture_url).attr("data-ratio-hw",a.picture_ratio_hw);this.data=a;setTimeout(function(){$("#route-stops").data("colset").update(true)},500)};W.search={SEARCH_URL:"https://api.foursquare.com/v2/venues/search"};
W.search.init=function(){this.$results=$("#search-results");this.$noResults=$("#no-results").hide();this.$newPlaceBtn=$("#add-new-place-btn").hide();this.$searchInput=$("#query");this.bindModal();this.bindSearch();this.bindNewPlaceModal()};W.search.bindModal=function(){var a=$("#stop-new-modal");a.modal({show:false});this.$modal=a;this.iframe=$('iframe[name="'+a.attr("target")+'"]')[0];this.$results.on("click","._search-result",function(){var b=$(this).data("data");W.search.addStop(b)})};
W.search.bindSearch=function(){function a(){if(e.val().length<W.globals.SEARCH_KEYDOWN_MINLEN){c.empty().removeClass("wait").hide();i.hide()}else{k.text(e.val());h.text(f.val());i.fadeIn();var g={ll:W.globals.LAT+","+W.globals.LNG,intent:"browse",query:e.val(),radius:W.globals.SEARCH_RADIUS,locale:W.globals.SEARCH_LOCALE,limit:W.globals.SEARCH_LIMIT,client_id:W.globals.FOURSQUARE_CLIENT_ID,client_secret:W.globals.FOURSQUARE_CLIENT_SECRET,v:"20120530"};W.search.FoursquareSearch(g)}}function b(){clearTimeout(d);
c.empty().removeClass("wait").hide();i.hide();if(!(e.val().length<W.globals.SEARCH_KEYDOWN_MINLEN)){W.search.$noResults.hide();W.search.$newPlaceBtn.hide();c.show().addClass("wait");d=setTimeout(a,W.globals.SEARCH_KEYDOWN_WAIT)}}this.tmpl_search_result=$("#tmpl-search-result").html();var c=this.$results.empty();this.$results=c;var d,f=W.geo.$cityInput,e=this.$searchInput,i=$("#results-title"),k=$("#results-title .search-term"),h=$("#results-title .search-location");e.keypress(b);e.keydown(function(g){g.which===
KEY_DELETE&&b()})};
W.search.FoursquareSearch=function(a){this.$results.css("height","auto").show().addClass("wait");$.ajax({url:W.search.SEARCH_URL,data:a,dataType:"json",success:function(b){W.search.$results.removeClass("wait").empty();var c,d,f=b.response.venues;for(b=0;c=f[b];b++){d=W.search.normalizeFoursquareData(c);W.route.stops[c.id]||W.search.showSearchResult(d)}W.search.$results.find("article").length==0&&W.search.$noResults.show();W.search.$results.data("colset").update(true);W.search.$newPlaceBtn.show()},error:function(b,
c,d){W.search.$results.removeClass("wait");console.error(d)}})};
W.search.normalizeFoursquareData=function(a){var b=[],c,d;for(c=0;d=a.categories[c];c++)b.push(d.id);return{place_id:a.id,name:a.name,address:a.location.address,crossStreet:a.location.crossStreet,city:a.location.city,state:a.location.state,country:a.location.country,lat:a.location.lat,lng:a.location.lng,place_type:a.categories[0]?a.categories[0].shortName:"-",place_type_id:b[0]||W.globals.DEFAULT_CAT_ID,phone:a.contact.phone,twitter:a.contact.twitter,website:a.url}};
W.search.showSearchResult=function(a){var b=$(W.search.tmpl_search_result);b.find(".stop-type").text(a.stop_type);b.find(".stop-name").text(a.name);b.find(".stop-address").text(a.address);b.find(".stop-cross-street").text(a.crossStreet);var c=b.find("img"),d=W.search.makeStaticMapURL(a.lat,a.lng);c.attr("src",d);c.attr("alt",a.name);b.appendTo(W.search.$results);b.data("data",a)};
W.search.makeStaticMapURL=function(a,b){return GMaps.staticMapURL({url:STATIC_MAPS_ROOT,size:W.globals.SEARCH_RESULTS_MAP_SIZE,zoom:W.globals.SEARCH_RESULTS_ZOOM_LEVEL,key:GOOGLE_API_KEY,marker:{lat:a,lng:b}})};
W.search.addStop=function(a){var b=W.search.$modal,c=$("#route-stops");b.find(".stop-name").text(a.name||"");b.find(".cat").text(a.place_type||"");b.find(".stop-address").text(a.address||"");b.find(".stop-cross-street").text(a.crossStreet||"");var d;$.each(a,function(f,e){d=b.find("[name="+f+"]");d.length&&d.val(e)});b.find("[name=description]").val("");b.modal("show");W.search.iframe.contentWindow.document.innerHTML="";W.search.iframe.removeAttribute("src");b.unbind("submit").submit(function(){W.search.$results.empty().css("height",
"auto");W.search.$newPlaceBtn.hide();$("#query").val("");c.addClass("wait");b.modal("hide")});W.search.iframe.onload=function(){c.removeClass("wait");var f=$(W.search.iframe.contentWindow.document.body),e;try{e=$.parseJSON(f.text())}catch(i){e=null}if(!e||e.error){f=e?e.error:f.html();$("#error").slideDown().find("div.error-body").html(f)}else{e.o=a;e=W.search.normalizeNewStopData(e);W.route.addStop(e)}}};
W.search.normalizeNewStopData=function(a){var b=a.circuit_stop,c=b.place,d=b.picture.thumbnails.squared;d||(d=W.search.makeStaticMapURL(c.coordinates.lat,c.coordinates.lng));var f=b.description;if(f==="None")f="";return{place_id:a.o.place_id,name:c.name,picture_url:d,description:f,address:c.address,place_type_id:c.place_type_id||W.globals.DEFAULT_CAT_ID,place_type:c.place_type&&c.place_type.short_name||"",update_url:b.update_url,_:""}};
W.search.bindNewPlaceModal=function(){function a(g){return'<img class="place_type_img" src="'+b.find('[value="'+g.id+'"]').attr("data-icon")+'"/>'+g.text}var b=$("#new-place-type");b.select2({formatResult:a,formatSelection:a});var c=$("#new-place-modal"),d=$("#new-place-name");b=$("#new-place-type");var f=$("#new-place-search"),e=$("#new-place-search-btn"),i,k,h;c.modal({show:false});W.search.$newPlaceBtn.on("click",function(g){g.preventDefault();g.stopPropagation();d.val("");f.val("");c.modal("show");
return false});c.on("shown",function(){h=h||[W.globals.LAT,W.globals.LNG];i=new GMaps({div:"#new-place-map",zoom:16,lat:h[0],lng:h[1],click:function(j){h=[j.latLng.lat(),j.latLng.lng()];k.setPosition(j.latLng)}});k=i.addMarker({lat:h[0],lng:h[1]});var g=function(j){GMaps.geolocate({success:function(l){h=[l.coords.latitude,l.coords.longitude];i.setCenter(h[0],h[1]);j&&j(h)}})};g(function(j){j=new google.maps.LatLng(j[0],j[1]);k.setPosition(j)});i.addControl({position:"top_right",text:"Geolocate",style:{margin:"5px",
padding:"1px 6px",border:"solid 1px #717B87",background:"#fff"},events:{click:g}});e.unbind().on("click",function(j){j.preventDefault();j.stopPropagation();GMaps.geocode({address:f.val(),callback:function(l,n){if(n=="OK"){k.setMap(null);var m=l[0].geometry.location;h=[m.lat(),m.lng()];i.setCenter(h[0],h[1]);k=i.addMarker({lat:h[0],lng:h[1]})}}});return false})});f.on("keydown",function(g){if(g.which==KEY_ENTER){g.preventDefault();g.stopPropagation();e.trigger("click");return false}});d.on("keydown",
function(g){if(g.which==KEY_ENTER){g.preventDefault();g.stopPropagation();return false}});c.submit(function(g){g.preventDefault();g.stopPropagation();g=$.trim(d.val());if(!g){d.focus().shakeIt();return false}W.search.addStop({name:g,place_type_id:b.val(),lat:h[0],lng:h[1]});c.modal("hide");return false})};
